---
title: "Untitled"
author: "Sara Altman"
date: "2/13/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r}
library(readxl)
library(tidyverse)
library(langcog)
library(broom)
library(knitr)
```


```{r}
library(tidyverse)
library(readxl)
library(langcog)
library(knitr)

# Parameters
three_toy_path <- "~/Dropbox/YouVWorld/Data/YouVWorldData_forSophie.xlsx"
three_toy_sheet <- "DataUpdated"

two_toy_path <- "~/Dropbox/YouVWorld/TwoToys/data/YouvWorld_TwoToys_SB.xlsx"
two_toy_sheet <- "Data"

modified_path <- "~/Dropbox/YouVWorld/TwoToys/new_version_data/YouVWorld_modified_toy_updated.xlsx"
modified_sheet <- "Data"

# Global variables
fig_num_counter <- 1
```

```{r}
# Helper functions for summary stats and setup
get_summ_stat <- function(data, stat, summary_var, ..., num_digits = 2){
  summary_var <- enquo(summary_var)
  stat <- enquo(stat)
  
  data %>% 
    filter(...) %>% 
    summarise(mean = round(mean(!!summary_var), num_digits),
              sd = round(sd(!!summary_var)), num_digits) %>% 
    pull(!!stat)
}

get_percentage_female <- function(data, ..., num_digits = 0){
  data %>% 
    filter(gender == "F", ...) %>% 
    summarise(percentage = round(n() / num_participants * 100, 0)) %>% 
    pull(percentage)
}

get_num_excluded <- function(data, exclude_code_var, ...){
  exclude_code <- enquo(exclude_code_var)
  
  data %>% 
    filter(`exclude?` == "yes") %>% 
    count(!!exclude_code) %>% 
    spread(!!exclude_code, nn) %>% 
    select(...) %>% 
    mutate(total = as.integer(rowSums(.))) %>% 
    rename_all(funs(str_replace_all(., " ", "_")))
}

format_data <- function(data) {
  data %>% 
    rename_all(funs(str_replace(., "1st", "first"))) %>% 
    rename(exclude = `exclude?`) %>% 
    mutate(condition = case_when(condition == "wrong action" ~ "Broken Button",
                                 condition == "broken toy" ~ "Broken Toy",
                                 condition == "person" ~ "Broken Button",
                                 condition == "toy" ~ "Broken Toy"),
           condition = fct_rev(condition),
           HelpfulCategory = str_to_title(HelpfulCategory) %>% 
             str_trim(side = "both"),
           firstBehaviorCode = str_to_lower(firstBehaviorCode),
           firstChoice = case_when(firstChoice == "confed" ~ "Confederate's toy",
                                   firstChoice == "other" ~ "Other toy",
                                   firstChoice == "tray" ~ "Other toy",
                                   firstChoice == "toy" ~ "Confederate's toy"),
           firstChoiceNum = as.integer(firstChoice == "Confederate's toy"),
           flip = str_detect(firstBehaviorCode, "flip"),
           age = as.double(age)) 
}
```

```{r}
# Results section helper functions

# Returns a tibble with the number + percentage of children in each condition, variable group
format_for_between_stats <- function(data, variable, variable_option) {
  variable <- enquo(variable)
  
  data %>%
    mutate(condition = fct_recode(condition, 
                                  bt = "Broken Toy",
                                  bb = "Broken Button")) %>% #this makes it easier to access variables later -- no longer have a space
    group_by(condition, !!variable) %>%
    summarise(n = n()) %>%
    mutate(percentage = n/sum(n) * 100) %>%
    ungroup() %>% 
    filter(!!variable == variable_option) %>% 
    unite("stat", condition, !!variable) %>% 
    mutate(num_bb = .$n[[1]],
           num_bt = .$n[[2]]) %>% 
    select(-n) %>% 
    spread(stat, percentage) %>% 
    mutate_all(~ round(., 0))
}

# Returns a p-value from a fisher's exact test 
get_fishers_p_value <- function(table, digits = 4) {
  fisher.test(table)[[1]] %>% round(digits)
}

# Returns stats (num, percentages, p-value) for response data
between_condition_response <- function(data, digits = 4) {
  data %>% 
    format_for_between_stats(variable = firstChoice, 
                             variable_option = "Other toy") %>% 
    rename(perc_bt_other = `Broken Toy_Other toy`,
           perc_bb_other = `Broken Button_Other toy`) %>% 
    mutate(p_value = get_fishers_p_value(
      table(data$condition, 
            data$firstChoice), digits))
}

# Returns stats (num, percentages, p-value) for helpfulness data
between_condition_helpful <- function(data) {
  data %>% 
  format_for_between_stats(variable = helpfulCategory,
                           variable_option = "Helpful") %>% 
  rename(perc_bb_helpful = `Broken Button_Helpful`,
         perc_bt_helpful = `Broken Toy_Helpful`) %>% 
  mutate(p_value = 
           get_fishers_p_value(table(data$condition, data$helpfulCategory)))
}

# Returns stats (num, percentages, p-value) for correctness data
between_condition_correct <- function(data) {
  data %>% 
    format_for_between_stats(variable = firstChoiceCorrect,
                             variable_option = 1) %>% 
    rename(perc_bb_correct = `Broken Button_1`,
           perc_bt_correct = `Broken Toy_1`,
           num_bb_correct = num_bb,
           num_bt_correct = num_bt) %>% 
    mutate(p_value = 
             get_fishers_p_value(table(data$condition, data$firstChoiceCorrect)))
}

between_condition_stats <- function(data, variable, variable_option) {
  variable <- enquo(variable)

  data %>%
    format_for_between_stats(variable = !!variable,
                             variable_option = variable_option) %>%
    rename_at(vars(contains(variable_option)), 
              funs(str_c("perc_", str_extract(., "[a-z][a-z]")))) %>% 
    mutate(p_value =
              get_fishers_p_value(table(data$condition, 
                                        data %>% pull(!!variable))))
}

between_condition_stats(two_toy_tidy, firstChoiceCorrect, "1")
```

```{r}
# Within condition stats helper functions
get_binom_p_value <- function(k, n, digits = 4) {
  binom.test(k, n, alternative = "two.sided")$p.value %>% 
    round(digits)
}

format_for_within_stats <- function(data, variable, variable_option) {
  variable = enquo(variable)
  
  data %>% 
    group_by(condition, !!variable) %>% 
    summarise(n = n()) %>% 
    ungroup() %>% 
    filter(!!variable == variable_option) %>% 
    unite("stat", condition, !!variable) %>% 
    spread(stat, n)
}

within_condition_response <- function(data, num_bt, num_bb) {
  three_toy_tidy %>% 
    format_for_within_stats(variable = firstChoice, 
                            variable_option = "Other toy") %>% 
    rename(num_bb_other = `Broken Button_Other toy`,
           num_bt_other = `Broken Toy_Other toy`) %>% 
    mutate(p_value_bt = get_binom_p_value(num_bt_other, num_bt),
           p_value_bb = get_binom_p_value(num_bb_other, num_bb))
}

within_condition_helpful <- function(data, num_bt, num_bb) {
  data %>% 
    format_for_within_stats(variable = helpfulCategory, 
                            variable_option = "Helpful") %>% 
    rename(num_bb_help = `Broken Button_Helpful`,
           num_bt_help = `Broken Toy_Helpful`) %>% 
    mutate(num_total_help = num_bb_help + num_bt_help,
           perc_total_help = num_total_help / (num_bt + num_bb) %>% round(0)) %>% 
    mutate(p_value_bt = get_binom_p_value(num_bt_help, num_bt),
           p_value_bb = get_binom_p_value(num_bb_help, num_bb))
}

within_condition_correct <- function(data, num_bt, num_bb) {
  data %>% 
    format_for_within_stats(variable = firstChoiceCorrect, 
                            variable_option = 1) %>% 
    rename(num_bb_correct = `Broken Button_1`,
           num_bt_correct = `Broken Toy_1`) %>% 
    mutate(num_total_correct = num_bb_correct + num_bt_correct,
           perc_total_correct = num_total_correct / (num_bt + num_bb) %>% round(0)) %>% 
    mutate(p_value_bt = get_binom_p_value(num_bt_correct, num_bt),
           p_value_bb = get_binom_p_value(num_bb_correct, num_bb))
}
```

```{r}
# Plot functions

# Returns a tibble that includes bootstrapped CI for the specified variable
# Variable option is the reference value of the specified variable (i.e., "Other toy")
get_bootstrapped_ci <- function(data, variable, variable_option) {
  variable <- enquo(variable)
  
  data %>%
    mutate(var_num = if_else(!!variable == variable_option, 1, 0)) %>%
    group_by(condition) %>%
    multi_boot_standard(col = "var_num") %>%
    mutate(Confederate = 1 - mean) %>% 
    ungroup()
}

# Plots the response plot. Captions with figure_num
response_plot <- function(data) {
  fig_num_counter <<- fig_num_counter + 1
  
  data %>% 
    get_bootstrapped_ci(firstChoice, "Confederate's toy") %>% 
    gather(key, val, mean, Confederate) %>% 
    ggplot(aes(x = condition, y = val, fill = key)) +
    geom_col(position = "fill", width = .7) +
    geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width = .1) +
    geom_hline(yintercept = .5, linetype = "dashed") +
    scale_fill_solarized(name = "Target toy of first response", 
                         breaks = c("Confederate", "mean"),
                         labels = c("Other toy", "Confederate's toy")) +
    theme_minimal() + 
    labs(x = "Condition",
         y = "Proportion of children",
         title = "Response by condition",
         caption = str_c("Figure", fig_num_counter, sep = " ")) +
    coord_fixed(ratio = 2/1)
}

help_plot <- function(data) {
  fig_num_counter <<- fig_num_counter + 1
  
  data %>% 
    get_bootstrapped_ci(helpfulCategory, "Helpful") %>% 
    mutate(unhelpful = 1 - mean) %>% 
    gather(key = "measure", value = "val", mean, unhelpful) %>% 
    mutate(measure = forcats::fct_rev(as.factor(measure))) %>% 
    ggplot(aes(x = condition, y = val, fill = measure)) +
    geom_col(width = .7) +
    geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width = .1) +
    geom_hline(yintercept = .5, linetype = "dashed") +
    scale_fill_manual(breaks = c("mean", "unhelpful"), 
                      labels = c("Successful", "Unsuccessful"), 
                      name = "Success of helping behavior",
                      values = c("#dddddd", "#addd8e"))  +
    labs(x = "Condition",
         y = "Proportion of children",
         title = "Success of help by condition",
         caption = str_c("Figure", fig_num_counter, sep = " ")) +
    theme_minimal() +
    coord_fixed(ratio = 2/1)
}

# Read in data
three_toy <- 
  read_xlsx(path = three_toy_path, 
            sheet = three_toy_sheet) %>% 
  rename(excludeCode = exclude_code)   # want all excludeCode variables named the same thing

two_toy <- 
  read_xlsx(path = two_toy_path, 
            sheet = two_toy_sheet)

modified <- 
  read_xlsx(path = modified_path, 
            sheet = modified_sheet)
```



```{r}
#formatting three toy data
three_toy_tidy <-
  three_toy %>% 
  format_data() %>% 
  filter(exclude != "yes",
         between(ageBucket, 2, 3),
         n != 109) %>% 
  mutate(firstChoiceCorrect = as.integer(firstChoiceCorrect)) %>% 
  select(-contains("second"),
         -contains("third"),
         -contains("fourth"),
         -contains("language"),
         -contains("?"),
         -contains("child's choice matches")) %>% 
  rename(helpfulCategory = HelpfulCategory)
```


# Experiment 1

## Methods

### Participants

```{r}
num_participants <- 
  three_toy_tidy %>% 
  nrow()

num_bb <- 
  three_toy_tidy %>% 
  filter(condition == "Broken Button") %>% 
  nrow()

num_bt <- num_participants - num_bb
  
female <- get_percentage_female(three_toy_tidy)

mean_age <- 
  three_toy_tidy %>% 
  get_summ_stat(mean, age)

sd_age <-
  three_toy_tidy %>% 
  get_summ_stat(sd, age)

mean_age_bt <-
  three_toy_tidy %>% 
  get_summ_stat(mean, age, condition == "Broken Toy")

sd_age_bt <-
  three_toy_tidy %>% 
  get_summ_stat(sd, age, condition == "Broken Toy")

mean_age_bb <-
  three_toy_tidy %>% 
  get_summ_stat(mean, age, condition == "Broken Button")

sd_age_bb <-
  three_toy_tidy %>% 
  get_summ_stat(sd, age, condition == "Broken Button")

#excluded kids 
# check that these codes are right--some are different than ones in cogsci
num_excluded <-
  three_toy %>% 
  get_num_excluded(excludeCode, parent, audio, exp, withdrew)
```

Fifty-two 24- to 48-month-olds (M(SD) = `r mean_age`(`r sd_age`)yrs, `r female` % female) from a museum in Palo Alto, CA participated. An additional `r num_excluded` children were excluded from analysis due to parental interference (n = `r num_excluded$parent`), experimenter error (n = `r num_excluded$experimenter`), shyness (n = `r num_excluded$withdrew`), or lack of video recording (n = `r num_excluded$audio`). We randomly assigned children to one of two conditions: the Broken Toy condition (n = `r num_bt`; M(SD) = `r round(mean_age_bt, 2)`(`r sd_age_bt`)yrs) or the Broken Button condition (n = `r bb`; M(SD) = `r mean_age_bb`(`r sd_age_bb`)yrs).

### Stimuli
We constructed three identical-looking toys. One side of each toy was covered in yellow felt and had a yellow button in the center. The opposite side was covered in red felt and had a red button in the center. The yellow button on two toys played music, while the yellow button on the third toy was inert. All red buttons were inert. The toys were placed on a white plastic tray and covered with grey felt. See Figure 1 for a schematic of the toys and procedure.

### Procedure
The experiment began with a *warm-up phase* in which a confederate and experimenter engaged the child in reciprocal games (e.g., rolling a ball back and forth through a tube) in order to help the child feel comfortable with the researchers, and promote general helping behavior (see Cortes Barragan & Dweck, 2014). After approximately 5 minutes of warm-up, the confederate excused herself from the room, explaining that she had work to do.

Then, the child gained experience with the toys during the *play phase*. The experimenter behaved as if she were exploring the toys for the first time. She took one toy out at a time and showed it to the child. In the Broken Toy condition, the toys were oriented such that the yellow side was on top. She noticed the yellow button, pressed it, and reacted positively to the music that played. She also encouraged the child to press the yellow button and again reacted positively, saying, “Music! The yellow side plays music!”. She then turned the toy around in her hands until she discovered the red button on the opposite side, and expressed mild surprise, as if she did not expect it to be there. She pressed the red button and also encouraged the child to do so, acting perplexed and disappointed that it did not play music. The experimenter then took the second toy out, which she and the child explored in the same way (i.e., the experimenter pressed each button, and then encouraged the child to do so). This second toy was always the broken toy. This process was repeated with the third toy, which functioned the same as the first (i.e., the yellow button played music, but the red button did nothing). The child and experimenter then explored each toy again, taking turns pressing the buttons. 

The Broken Button condition proceeded identically except that the toys were placed with the red side up, such that the red button was discovered first, and then the yellow. By the end of the play phase, all children experienced that pressing the yellow buttons on two of the toys played music (and one was inert), and that none of the red buttons played music.

In the helping phase, the experimenter placed toys back on the tray and covered them with the felt. The toys were placed as they were during the play phase: yellow-side-up in the Broken Toy condition, and red-side-up in the Wrong Ac- tion condition. The child sat approximately 6 ft away from the tray, either by him-/herself or with a parent. The exper- imenter then called the confederate back into the room and explained that she and the child were playing with toys that played music. The confederate said, “I love music!” and knelt down behind the tray, facing the child. She appeared to select a toy at random from behind the felt; the child could not see which toy was chosen.

### Coding
We were interested in children’s first helping behavior after the confederate’s failure to activate her toy (i.e., her first button press). The key dependent measure was the target toy of this behavior, coded as either the “confederate’s toy” or the “toys on the tray”. All children who responded fell into one of these two categories.

We also looked at the consequence of children’s first helping responses. We coded whether their behavior was “successful or “unsuccessful” in achieving the confed- erate’s goal of playing music. In the Broken Toy condition, we coded a child’s first response as “successful” if the child pressed the yellow button on a toy from the tray or directed the confederate to press it (e.g., telling her to do so; handing or pointing to a toy yellow side up). “Unsuccessful” responses included pressing or directing the confederate to press the red button on any toy or the yellow button on the confederate’s toy. In the Wrong Action condition, a behavior was coded as “successful” if a child flipped and pressed the yellow button or directed the confederate to do so (e.g., telling her to press it, flipping a toy and handing or pointing to it yellow-side- up). Thus, in the Wrong Action condition, a behavior could be successful regardless of which toy a child’s first response targeted, whereas in the Broken Toy condition, only behavior directed toward the toys on the tray could be successful. The first and second author transcribed and coded children’s behavior and a researcher blind to the hypotheses coded these transcriptions for reliability and agreement was 100%.

# Results

```{r}
# Response: Between condition differences -- Fisher's exact test
between_response <- 
  three_toy_tidy %>% 
  between_condition_response()

# Response: Within condition differences -- 2 two-tailed binomial tests
within_response <- 
  three_toy_tidy %>% 
  within_condition_response(num_bt, num_bb)

# Helpfulness: Between condition differences -- Fisher's exact test
between_help <-
  three_toy_tidy %>% 
  filter(n != 11) %>% 
  between_condition_helpful()

# Helpfulness: Within condition differences -- 2 two-tailed binomial tests
within_help <-
  three_toy_tidy %>% 
  filter(n != 11) %>% 
  within_condition_helpful(num_bt, num_bb) 

glm_fit <- 
  glm(firstChoiceCorrect ~ condition + age, 
                  family = "binomial", 
                  data = three_toy_tidy) %>% 
  tidy()

age_stats <- 
  glm_fit %>% 
  filter(term == "age") 

condition_stats <-
  glm_fit %>% 
  filter(term == "conditionBroken Button")
```

Children in both conditions saw the same set of toys and watched the confederate perform the same action (pressing an obvious button on the top of a toy, which subsequently did not play music). All children could then either approach the toy the confederate had just pressed or a toy on the tray. The conditions differed in the likely source of the confederate's failure to play music, which we manipulated by varying whether the obvious button pressed by the confederate was the type of button that worked on a majority of the toys (i.e., a yellow button; Broken Toy condition) or the type of button that was always inert (i.e., a red button; Broken Button condition).  

We predicted responses to vary across conditions depending on the source of the confederate’s failure. In the Broken Toy condition, the source of the confederate's failure is likely the toy itself--since she presses a yellow button that works on all toys except one, she must have the inert toy. Therefore, the child can only help the confederate achieve her goal of playing music by targeting a new toy (a toy on the tray). In the Broken Button condition, however, the child can only infer that the confederate is pressing an inert buttton. Each toy has an inert red button, so the child cannot infer which toy (i.e., functional or non-functional) the confederate has chosen. Therefore, in this condition, children could help the confederate by approaching her toy, since the toy may have a functional yellow button on the bottom. We thus predicted that more children would approach the “toys on the tray” in the Broken Toy condition than in the Wrong Action condition. As predicted, children were significantly more likely to direct their help toward a toy on the tray in the Broken Toy condition than in the Wrong Action condition (`r perc_between_response$bt_other`% vs. `r perc_between_response$bb_other`%; two-tailed Fisher’s Exact Test, p = `r between_response$p_value`).

```{r}
three_toy_tidy %>% 
  response_plot()
```


We then looked at children’s responses within each condition. In the Broken Toy condition, no action on the confederate's toy could produce music and therefore help the confederate fulfill her goal. We thus predicted that children in this condition would preferentially direct their help toward a toy on the tray and, as predicted, children were more likely to approach the “toys on the tray” than the “confederate’s toy” (`r within_response$num_bt_other`/`r num_bt`; two-tailed binomial test, p = `r within_response$p_value_bt`).

In the Broken Button condition, however, it is ambiguous whether or not the confederate has the fully inert toy. There is a 33% chance any toy the child flips over will have an inert yellow button. Since all toys are now equally likely to produce music, it is helpful for the child to target any toy. However, there are reasons to expect that children would prefer the confederate's toy in this condition. First, children may be inclined to approach the toy just acted upon by the confederate. Second, it is reasonable to conclude from the confederate's actions that she not only wants help playing music, but also that she wants help playing music specifically with her chosen toy. Thus, we expected that children might show a mild preference for the confederate’s toy. The majority of children in the Broken Button condition did approach the "confederate's toy" (`r num_bb - within_response$num_bb_other`/`r num_bb`; two-tailed binomial test, p = `r within_response$p_value_bb`). See Figure 2 for a summary of children’s first responses.

As a secondary measure of interest, we looked at the success of children's helping responses. We considered responses successful if they helped the confederate produce music. In the Broken Toy condition, a behavior could be successful only if it involved approaching the "toys on the tray." In the Broken Button condition, successful behaviors involved revealing a bottom button on any of the toys. Therefore, it is plausible that helping successfully is more difficult in the Broken Button condition than in the Broken Toy condition. However, we found no difference in success of helping behavior across the two conditions (`r between_help$perc_bt_helpful`% in Broken Toy vs. `r perc_bt_helpful` in Broken Button; two-tailed Fisher’s Exact Test, p = `r between_help$p_value`). Children within each condition were also more likely to help successfully than unsuccessfully (Broken Toy: `r num_bt_help`/`r num_bt`; Broken Button: `r num_bb_help`/`r num_bb - 1`). One child in the Broken Button condition was dropped from this analysis because the camera angle prevented visual access to the content of her helping behavior.

```{r}
three_toy_tidy %>%
  filter(n != 11) %>% 
  help_plot()
```


Finally, as an exploratory analysis, we re-coded children’s first responses as “correct” (Broken Toy: “toys on tray”; Wrong Action: “confederate’s toy”) or “incorrect”. We fit a generalized linear model with correctness as the outcome variable, condition as a categorical predictor variable, and age as a continuous predictor variable. This analysis revealed that age is a significant predictor of "correctness" ($\Beta$ = `r age_stats$estimate`, p = `r age_stats$p.value`), but that condition is not ($\Beta$ = `r condition_stats$estimate`, p = `r condition_stats$p.value`).


# Experiment 2

In Experiment 1, the toys were color-coded such that all red buttons were inert, and 2/3 of yellow buttons played music. Therefore, in the Broken Button condition, children do not necessarily have to reason about the cause of the confederate's failure. Instead, it is possible to just remember that yellow sides play music, and target a yellow side when the confederate asks for help. The helpful action is marked by a color. This is not the case, however, in the Broken Toy condition, since the confederate presses a yellow button and the toy does nothing. In order to help the confederate in this condition, children need to target a yellow button on a *new* toy and cannot simply target a particular color. This is an asymmetry between the two conditions. To eliminate this alternative explanation in the Broken Button condition as well as the asymmetry between the two conditions, we designed a second experiment with two identical toys. 

## Methods

### Participants

```{r}
# for some reason there are some NA's still in the age column? I thought we fixed this?
two_toy_tidy <-
  two_toy %>% 
  format_data() %>% 
  filter(exclude == "no") %>% 
  mutate(helpfulCategory = HelpfulCategory,
         firstChoiceCorrect = as.integer(firstChoiceCorrect))
  

num_participants <- 
  two_toy_tidy %>% 
  nrow()

mean_age <- 
  two_toy_tidy %>% 
  get_summ_stat(mean, age)

sd_age <- 
  two_toy_tidy %>% 
  get_summ_stat(sd, age)

female <- 
  two_toy_tidy %>% 
  get_percentage_female()

num_bt <- 
  two_toy_tidy %>% 
  filter(condition == "Broken Toy") %>% 
  nrow()

mean_age_bt <-
  two_toy_tidy %>% 
  get_summ_stat(mean, age, condition == "Broken Toy")

sd_age_bt <-
  two_toy_tidy %>% 
  get_summ_stat(sd, age, condition == "Broken Button")

num_bb <- num_participants - num_bt

mean_age_bb <-
  two_toy_tidy %>% 
  get_summ_stat(mean, age, condition == "Broken Button")

sd_age_bb <-
  two_toy_tidy %>% 
  get_summ_stat(sd, age, condition == "Broken Toy")

# excluded kids
two_toy %>% 
  filter(`exclude?` == "yes") %>% 
  count(excludeCode)

num_excluded <-
  two_toy %>% 
  get_num_excluded(excludeCode, 
                   `experimenter error`, 
                   `pre-failure help`, 
                   `played before`,
                   `video`)
```


We recruited `r num_participants` 24- to 48-month-old participants (M(SD) = x, `r female`% female) from a local preschool. An additional `r num_excluded$total` children were excluded from analysis due to experimenter error (n = `r num_excluded$experimenter_error`), the child responding too early (n = `r num_excluded$pre-failure_help`), the child having prior exposure to the experiment (n = `r num_excluded$played_before`), or lack of video recording (n = `r num_excluded$video`).

We randomly assigned children to one of two conditions: the Broken Toy condition (n = `r num_bt`; M(SD) = `r round(mean_age_bt, 2)`(`r round(sd_age_bt, 2)`)yrs) or the Broken Button condition (n = `r bb`; M(SD) = `r round(mean_age_bb, 2)`(`r round(sd_age_bb, 2)`)yrs).

### Stimuli

We constructed four toys, similar to those used in Experiment 1. Two opposite sides of each toy were covered in red felt and had a red button in the center. The others sides of the toys were covered in blue felt. For two of the four toys, the button on one side played music when pressed, while the other was inert. Both buttons on one of the other two toys played music, while neither button on the final toy did anything. The fully functional and the inert toys were used in the Broken Toy condition. The two identical, half-functional toys were used in the Broken Button condition. In each condition, the two toys were placed in a woven basket. See Figure X for a schematic of the toys and procedure.

### Procedure

As in Experiment 1, the experiment consisted of a warm-up phase, play phase, and helping phase. The *warm-up phase* in this experiment was the same as in Experiment 1, but was two minutes shorter, as the children were already familiar with the experimenter and room in which the experiment was held.

In the *play phase*, children gained experience with two of the four toys. As in Experiment 1, the experimenter behaved as if she were exploring the toys with the child. She took one toy out of the basket at a time and showed it to the child. 

In contrast to Experiment 1, however, children saw different sets of toys in each condition. The child engaged with the fully inert toy and the fully functional toy in the Broken Toy condition. In the Wrong Action condition, the child engaged with the two identical toys on which one button played music and one button was inert. The experimenter helped the child explore the toys in an identical manner as in Experiment 1. 

In the *helping phase*, the experimenter returned the toys to the basket before placing one toy X1 to the right of the child and Y feet in front of her, and the other X2 feet to the left of the child and Y feet in front of her. In the Broken Button condition, both toys were oriented so that the inert button was on top. As in Experiment 1, the experimenter called the confederate back into the room and explained that she and the child were playing with toys that played music. The confederate responded, "I love music!" and stood X3 feet behind the toys such that she was equidistant from each toy. She then glanced at each toy, then looked at one adn said, "Hmm, I think I'll play with this one." She knelt behind her chosen toy and pressed the top button, which did not play music. As in Experiment 1, she remarked, "Hmm, no music!" and then pressed it again and said, "Still no music!" She then returned, still kneeling, to the spot X feet behind the toys equidistant from each and said, "I really want music! Can you show me?" while gesturing to each toy simultaneously.

If the child did not respond, the confederate and experimenter provided additional prompts as in Experiment 1, ending in moving the toys closer to the child.

If the child provided help that did not involve a physical demonstration (i.e., pointed or gave verbal instructions) before the confederate moved back to the center and gave her prompt, the confederate indicated that she had noticed the help by saying, "Ooh," moved back to the center, and said, "Can you show me?" If the child did not respond, the experimenter and confederate continued prompting as explained above.

### Coding

As in Experiment 1, the key dependent measure was the target of the child's first response after the confederate's failure. This target was either the toy that the confederate had acted upon ("confederate's toy"), or the other toy that she had not touched ("other toy"). All children included in this experiment fell into one of these two categories. 

We also looked at the effect of each child's first response. We coded a response as "successful" if the behavior helped the confederate play music, and "unsuccessful" otherwise. In the Broken Toy condition, we coded a response as "successful" if the child pressed a button on the other toy or indicated (by pointing or verbally instructing) that the confederate should do so. We coded a response as "unsuccesful" if the target of the child's first behavior was the confederate's toy. In the Broken button condition, we coded a response as "successful" if the child flipped and pressed the bottom button on either of the two toys, or indicated (by pointing or verbally instructing) that the confederate should flip and press a bottom button. Unsuccessful behaviors involved acting on a top button or indicating that the confederate should act on a top button.

[include coding contents of helping behavior?]

# Results
```{r}
# Response: Between condition differences -- Fisher's exact test
between_response <- 
  two_toy_tidy %>% 
  between_condition_response()

# Response: Within condition differences -- 2 two-tailed binomial tests
within_response <- 
  two_toy_tidy %>% 
  within_condition_response(num_bt, num_bb)

# Helpfulness: Between condition differences -- Fisher's exact test
between_help <-
  two_toy_tidy %>% 
  between_condition_helpful()

# Helpfulness: collapsed across conditions -- two-tailed binomial test
collapsed_help <-
  two_toy_tidy %>% 
  count(helpfulCategory) %>% 
  spread(helpfulCategory, nn) %>% 
  mutate(p_value = get_binom_p_value(Helpful, num_participants, digits = 7))

glm_control <-
  glm(firstChoiceCorrect ~ toySide + experimenter + confederate, 
      family = "binomial", 
      data = two_toy_tidy)

glm_fit <- 
  glm(firstChoiceCorrect ~ condition + age, 
                  family = "binomial", 
                  data = two_toy_tidy) %>% 
  tidy()

age_stats <- 
  glm_fit %>% 
  filter(term == "age") 

condition_stats <-
  glm_fit %>% 
  filter(term == "conditionBroken Button")

two_toy_tidy %>% 
  filter(condition == "Broken Toy") %>% 
  count(helpfulCategory)
```

To verify that children did not express a side bias or preference for any confederate or experimenter, we ran a logistic regression with "correctness" of response as the outcome and toy side, experimenter identity, and confederate identity as predictors. None were signficant predictors of correctness. 

Children in each condition saw identical-looking toys. The only difference across the two conditions was the functionality of the toys. In the Broken Toy condition, one toy has two functional buttons and the other has two inert buttons. When the confederate presses the top button on her own toy, the child can then know that she has the broken toy. The only way to effectively help the confederate with her goal of playing music is to act on the other toy. In the Broken Button condition, the toys are identical. Each toy has one functional button and one inert button. Once the confederate presses the top button on her toy, it's possible to infer that the bottom button will be functional. It is therefore reasonable to help by targeting the "confederate's toy". However, the "other toy" also has a functional button, and so targeting this toy can also address the confederate's goal of playing music. Since it is reasonable for children to target either toy in this condition, we predicted that children would be more likely to target the "other toy" in the Broken Toy condition than in the Broken Broken Button condition. As predicted, children were significantly more likely to direct their help toward the "other toy" in the Broken Toy condition than in the Broken Button condition (`r bewteen_reponse$perc_bt_other`% % vs. `r between_response$perc_bb_other`%; two-tailed Fisher’s Exact Test, p = `r between_response$p_value`).

```{r}
two_toy_tidy %>% 
  response_plot()
```


We also looked at responses within each condition. In the Broken Toy condition, since the only way to help the confederate in her goal to play music is to target the "other toy", we predicted that children would be more likely to target the "other toy" than the "confederate's toy." We found that children were more likely to approach the “other toy” than the “confederate’s toy” (`r within_response$num_bt_other`/`num_bt`; two-tailed binomial test, p = `r within_response$p_value_bt`).

We did not have a directed prediction for the Broken Button condition, as it is reasonable to target either toy. Children in the Broken Button condition showed no preference for either toy (`r num_other_bb`/`num_bb`; two-tailed binomial test, p = `r p_value_bb`).

Again, as a secondary measure, we looked at the success of children's helping behaviors. Successful behaviors included only those that aided the confederate in her goal of playing music. In the Broken Toy condition, children could successfully help only if they targeted the other toy. In the Broken Button condition, children could successfully help if they targeted either the bottom button on the confederate's toy, or the bottom button on the other toy [seems kind of confusing why this is maybe clarify]. We again found no difference in the success of helping behavior across the two conditions (`r between_help$perc_bt_helpful`% in Broken Toy vs. `r perc_bt_helpful` in Broken Button; two-tailed Fisher’s Exact Test, p = `r between_help$p_value`). We then collapsed across conditions and found that children were more likely to successfully help than to unsuccessfully help (`r collapsed_help$Helpful`/`num_participants`; two-tailed binomial test, p = `r collapsed_help$p_value`).

```{r}
two_toy_tidy %>% 
  help_plot()
```

As another secondary analysis, we investigated how often children in each condition exhibited the "correct" response. In the Broken Toy condition, "correct" responses are those that target the other toy. In the Broken Button condition, "correct" responses are those that target the confederate's toy. 

```{r}
between_correct <-
  two_toy_tidy %>% 
  between_condition_correct()

collapsed_correct <-
  two_toy_tidy %>% 
  count(firstChoiceCorrect) %>% 
  spread(firstChoiceCorrect, nn) %>% 
  rename(incorrect = `0`,
         correct = `1`) %>% 
  mutate(p_value = get_binom_p_value(correct, num_participants, digits = 7))
```

We found no significant difference across conditions (`r bewteen_correct$perc_bt_correct`% % vs. `r between_correct$perc_correct`%; two-tailed Fisher’s Exact Test, p = `r between_correct$p_value`). We then collapsed across conditions to test if children were more likely to respond "correctly" or "incorrectly" versus the alternative. Children were more likely to respond "correctly" than "incorrectly" (`r collapsed_correct$correct`/`num_participants`; two-tailed binomial test, p = `r collapsed_correct$p_value`)


## [transition to modified experiment--put somewhere]
It is not clear exactly what the confederate's goal are from her actions. Again, the confederate chooses a toy and expresses that she is interested in playing music. She then asks the child to show her. She may have a "specific" goal of playing music with her chosen toy, or a "general" goal of playing music with either toy. If she holds the specific goal, you can help her by showing her how to produce music on her chosen toy. However, since the toys are identical, you can also demonstrate to her how to operate her own toy on the "other toy." If she has the "general" goal of playing music regardless of toy, then showing her on either toy helps her achieve her goal. 

Children show no preference for either toy in the Broken Button condition, in contrast to Experiment 1, in which children in the Broken Button condition preferentially targeted the confederate's toy. There are several reasons why targeting the confederate's toy seems more appropriate in this condition. First, children have more information about the confederate's toy. The confederate presses a button on the top of the toy and it does nothing. If children remember how the toys work, they can infer that the bottom button on the confederate's toy must therefore be the functional button. They have no such information about other toy. In this experiment, the functional and non-functional sides are not marked and it is therefore not clear which button will produce music on the other toy. Therefore, if children want to maximize the chance of producing music, it makes sense to target the bottom button on the confederate's toy. Second, the confederate chooses one toy over another, both verbally by remarking, "Hmm, I think I'll play with this one," and by phyiscally kneeling down behind her chosen toy and pressing a button on that toy only. It seems reasonable to conclude that these actions indicate that she has a preference for one toy over another. However, children do not preferentially target the confederate's toy. Here are several possible explanations for this behavior.

```{r}
early_helpers <-
  two_toy_tidy %>% 
  filter(`#ConfedPrompts` == 0, `#ExpPrompts` == 0) %>% 
  count(firstChoice) %>% 
  spread(firstChoice, nn) %>% 
  rename(confed = `Confederate's toy`,
         other = `Other toy`) %>% 
  mutate(total = confed + other)
```


1. Children are forgetting which toy the confederate acted upon and therefore do not have a preference for either toy since they are visually identical. This could explain the difference in behavior between children in Experiment 1 and this experiment because in Experiment 1 the other toys are on a tray and therefore visually marked. However, this is unlikely for several reasons. First, if children are forgetting which toy the confederate acted upon after she moves to the center of both toys and asks her question, children should also show no preference for either toy in the Broken Button condition, as the toys in that condition are also visually identical. [have possible counterargument to this -- think about later] Second, there are `r early_helpers$total` children who offer help while the confederate is still kneeling at her toy, before she moves back to the center and asks for help. These children also do not show a preference for either toy--`r early_helpers$confed` target the confederate's toy and `r early_helpers$other` target the other toy. 

2. Children have an aversion to the confederate's toy since they just saw the confederate act upon that toy and fail. However, if children are aversed to operating a toy upon which someone else just failed, we should see that aversion in the Broken Button condition in Experiment 1 as well. 

```{r}
bb_other_targeters <-
  two_toy_tidy %>% 
  filter(condition == "Broken Button", 
         firstChoice == "Other toy") %>% 
  count(flip) %>% 
  spread(flip, nn) %>% 
  rename(flip = `TRUE`,
         no_flip = `FALSE`) %>% 
  mutate(total = flip + no_flip)

bb_confed_targeters <-
  two_toy_tidy %>% 
  filter(condition == "Broken Button", 
         firstChoice == "Confederate's toy") %>% 
  count(flip) %>% 
  spread(flip, nn) %>% 
  rename(flip = `TRUE`,
         no_flip = `FALSE`) %>% 
  mutate(total = flip + no_flip)
```

3. Children do not think the confederate's gaol is to play music with her chosen toy. Instead, they think her goal is just to play music. We will call this the *general goal*, in contrast to the *specific goal* of playing music with a particular toy. Although the confederate does verbally indicate a choice and operate a single toy, she then moves so that she is back between the two toys before saying, "I really want to play music. Can you show me?" She also gestures with both arms towards both toys while doing so. Therefore, while the confederate is explicitly asking for music and stating her goal, she demonstrates an indifference towards either toy. Children may interpret these actions as overriding her earlier demonstrated preference for one toy over another and therefore attribute the general goal to the confederate. If the confederate has no toy preference, it is helpful to target either toy. this does not address, however, the fact that children have more information about the confederate's toy than the other toy. Even if children attribute the general goal to the confederate, it is still a better bet to flip over the confederate's toy (100% chance of music) than it is to try either button on the other toy (each has a 50% chance of music). It is possible that children are not taking this into consideration, or that they assume the toys are oriented identically (i.e., the top button on the other toy is also the inert button). It is unlikely that children think the toys are oriented identically, however. First, they have no reason to assume they are oriented identically--they are oriented differently during the training phase and neither the confederate or experimenter indicates that they are oriented in any particular way during the helping phase. Furthermore, if children assume the toys are oriented identically, children who target the other toy in this condition should preferentially target the bottom button, as the do the children who target the confederate's toy. However, of the `r bb_other_targeters$total` in the Broken Button condition who target the other toy, `r bb_other_targeters$flip` target the bottom button and `r bb_other_targeters$no_flip` target the top button. This is contrast to the `r bb_confed_targeters$flip` out of `r bb_confed_targeters$total` who target the bottom button on the confederate's toy.

4. Children do attribute the specific goal to the confederate (i.e., they think she wants to play music with her chosen toy). However, because the toys are identical, they believe that demonstrating on either toy can help fulfull the confederate's goal. Under this theory, if a child targets the other toy, s/he thinks that the confederate wants to play music with her chosen toy, but believe they can show her the correct way to do so on the other toy, since the toys are visually and functionally identical. However, it then seems reasonable to expect that children who target the other toy will preferentially target the bottom button, as it is not informative to the confederate for the child to push the top button on the other toy if her goal is to play music on her own toy. The confederate  does not appear to know that the bottom button exists, or that her own toy has a functional button. '

It is possible that a combination of these explanations are occurring--i.e., some children are attributing the general goal to the confederate, some are attributing the specific goal, some forget which toy she acted upon, some are aversed to acting on the confederate's toy. It is also possible that multiple of these are in effect in one child. For example, a child could attribute the specific goal to the confederate and also have an aversion to the confederate's toy. 

It is not possible to determine whether children are attributing the specific or general goal to the confederate in this experiment. 


# Experiment 3
In this experiment, we change the structure of one toy in each pair such that the toys are visually distinct. It is now no longer helpful to demonstrate how to the confederate how her own toy works on the other toy. Furthermore, we believe having visually distinct toys makes it more likely that children will attribute a toy preference to the confederate. Therefore, we predict  that children in the Broken Button condition will now preferentially target the confederate's toy. We predict that children in the Broken Toy condition will continue to preferentially target the other toy.

## Methods

### Participants

```{r}
modified_tidy <-
  modified %>% 
  format_data() %>% 
  filter(exclude != "yes") %>% 
  rename(helpfulCategory = HelpfulCategory) %>% 
  mutate(as_predicted = case_when(
                          condition == "Broken Toy" & firstChoice == "Other toy" ~
                            1,
                          condition == "Broken Button" & firstChoice == "Confederate's toy" ~
                            1,
                          TRUE ~ 0
                        ))

num_participants <- modified_tidy %>% nrow()

mean_age <- 
  modified_tidy %>% 
  get_summ_stat(mean, age) 

sd_age <- 
  modified_tidy %>% 
  get_summ_stat(sd, age) 

females <- 
  modified_tidy %>% 
  get_percentage_female()

num_jmz <- 
  modified_tidy %>% 
  filter(location == "JMZ") %>% 
  nrow()

age_jmz <- modified_tidy %>% get_summ_stat(mean, age, location == "JMZ")
sd_jmz <- modified_tidy %>% get_summ_stat(sd, age, location == "JMZ")

num_bing <- num_participants - num_jmz

age_bing <- modified_tidy %>% get_summ_stat(mean, age, location != "JMZ")
sd_bing <- modified_tidy %>% get_summ_stat(sd, age, location != "JMZ")

num_excluded <- 
  modified %>% 
  get_num_excluded(excludeCode, 
                   early, 
                   `already played`, 
                   experimenter, 
                   `no video`, 
                   parent, 
                   sibling, 
                   stop)

#is shyness not helping? or withdrawing from the game?

num_bt <- 
  modified_tidy %>% 
  filter(condition == "Broken Toy") %>% 
  nrow()

num_bb <- num_participants - num_bt
#currently are 38 in bb and 36 in bt ... fix later
```

We recruited `r num_participants` 24- to 48-month-old participants (M(SD) = `r mean_age`(`r sd_age`), %% female). `r num_jmz` of these participants (M(SD) = `r age_jmz`(`r sd_jmz`)) were recruited from a museum in Palo Alto, CA. `r num_bing` of these participants (M(SD) = `r age_bing`(`r sd_bing`)) were recruited from a local preschool. An additional `r num_excluded$total` children were excluded from analysis due to experimenter error (n = `r num_excluded$experimenter`), parental or sibling interference (n = `r num_excluded$parent + num_excluded$sibling`), the child responding too early (n = `r num_excluded$early`), the child having prior exposure to the experiment (n = `r num_excluded$already_played`), or lack of video recording (n = `r num_excluded$no_video`).

We randomly assigned children to one of two conditions: the Broken Toy condition (n = `r num_bt`; M(SD) = `r round(mean_age_bt, 2)`(`r sd_age_bt`)yrs) or the Broken Button condition (n = `r bb`; M(SD) = `r mean_age_bb`(`r sd_age_bb`)yrs).

### Stimuli

We constructed three pairs of toys. One toy in each pair looked identical to the toys constructed in Experiment 2 (*top-bottom toys*). The other three toys had a button on the top and on an adjacent side (*top-side toys*), instead of on the top and bottom, but were otherwise identical to the toys in Experiment 2. The toys in one pair each had one functional button and one inert button. For the other two pairs of toys, one toy had two functional buttons and the other had two inert buttons. In one of these pairs, the functional toy was a top-bottom toy; in the other pair, the functional toy was a top-side toy.

### Procedure

Again, the experiment consisted of a warm-up phase, play phase, and helping phase. The warm-up phase was identical to the warm-up phase in Experiment 2.

The play phase was also identical to the play phase in Experiment 2, except that each child saw one top-side toy and one top-bottom toy. Children were again assigned to either the Broken Button or Broken Toy condition. Each child in the Broken Button condition played two toys that each had one functional button and one inert button. Half of children in the Broken Toy condition played with a functional top-side toy and an inert top-bottom toy, and half played with a functional top-bottom toy and an inert top-side toy.

The top-side toys were placed such that an inert button was on top and the side button faced the child. The helping phase then proceeded identically to the helping phase in Experiment 2. 

### Coding

Again, we coded the target of each child's first behavior after the confederate's failure (i.e., her first button press). This target was either the confederate's toy or the other toy, and all children who responded fell into one of these two categories. 

As in the previous two experiments, we also coded responses as successful or unsuccessful. The criteria were the same as in Experiment 2 for both conditions. 

# Results

To verify that children did not express a bias for a particular toy type, side, confederate, or experimenter, we ran a logistic regression with all of the listed variables as predictors and an indicator variable representing whether or not children repsonded as predicted (i.e., targtted the confederate's toy in Broken Button or other toy in Broken Toy) as the response. None of the predictors were significant [maybe see a table?]

```{r}
# we technically preregistered as running two of these? but i'm pretty sure this is equivalent...
glm_control <-
  glm(as_predicted ~ toySide + toyType + experimenter + confederate, 
      family = "binomial", 
      data = modified_tidy) %>% 
  tidy()
```


```{r}
between_response <-
  modified_tidy %>% 
  between_condition_response(digits = 9)

within_response <-
  modified_tidy %>% 
  within_condition_response(num_bt, num_bb)

modified_tidy %>% 
  response_plot()
```

Again, we predicted that responses would vary across conditions depending on the source of the confederate's failure, and that children in the Broken Toy condition would be more likely to target the "other toy" than children in the Broken Button condition. As predicted, children were significantly more likely to direct their help toward the "other toy" in the Broken Toy condition than in the Broken Button condition (`r between_response$perc_bt_other`% % vs. `r between_response$perc_bb_other`%; two-tailed Fisher’s Exact Test, p = `r between_response$p_value`). This replicates the findings in Experiment 1 and 2.

As in the previous two experiments, we also predicted and found that children within the Broken Toy condition would be more likely to target the "other toy" than the "confederate's toy" (`r within_response$num_bt_other`/`num_bt`; two-tailed binomial test, p = `r within_response$p_value_bt`).

In contrast to Experiment 2, we predicted that children within the Broken Button condition would preferentially target the "confederate's toy" over the "other toy." the two toys in this experiment are visually different. Therefore, in the Broken Button condition, children can no longer effectively help the confederate by demonstrating the correct action on the "other toy." Additionally, because the toys are visually distinct, it now appears more likely that the confederate expresses a preference for one type of toy over the other when she selects a toy to operate. If children interpret her choice as a preference for her chosen type of toy, then they may also think it is more likely that she holds the "specific" goal of playing music with her chosen toy, and not the "general" goal of playing music with either toy. As predicted, children in this condition were more likely to target the "confederate's toy" than the "other toy" (`r within_response$num_bb_other`/`num_bb`; two-tailed binomial test, p = `r within_response$p_value_bb`).

```{r}

```


As a secondary analysis, we investigated whether the proportion of children who behaved as predicted differed across conditions. Again, behaving as predicted consists of targeting the other toy in the Broken Toy condition and the confederate's toy in the Broken Button condition. 














